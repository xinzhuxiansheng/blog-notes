--In Blog
--Tags: 数据结构与算法,技术知识点
--CreateTime: 2021-01-19 03:11:00
--Status: 未发布

# 限流算法

>限流常用的四种算法：固定窗口(计数器)、滑动窗口、漏桶算法和令牌桶算法


## 固定窗口
一种简单的限流算法就是给出一个单位时间，然后使用一个计数器counter统计单位时间内收到的请求数量，当请求数量超过门限时，余下的请求丢弃或者等待。
`这种简单的算法有一个严重的问题: 就是很难控制边界时间上的请求。假设时间单位是1秒，每秒请求不超过10个。如果在这一秒的前半秒没有请求，而后半秒有10个请求，下一秒的前半秒又有10个请求，那么在这中间的一秒内，就会合理处理20个请求，而这明显违反了限流的基本需求。这是一种简单粗暴的总数量限流而不是平均限流` 

![限流算法-计数器](http://img.xinzhuxiansheng.com/blogimgs/technicalessential/限流算法-计数器.png)

## 滑动日志
固定窗口算法，也就是用一个固定的时间窗口来跟踪速率，每一个请求会增加这个窗口中的计数器，请求来了加1，处理完成就会减1。如果这个计数器超过了阈值，后续的请求就会被丢弃
![限流算法-滑动日志](http://img.xinzhuxiansheng.com/blogimgs/technicalessential/限流算法-滑动日志.png)


## 滑动窗口
滑动窗口是一种改进算法，综合了固定窗口和滑动日志两种方法的优点。它结合了固定窗口算法的低处理成本和滑动日志改进的边界条件，将当前时间窗口与过去时间窗口综合考虑。与固定窗口算法一样，滑动窗口根据请求更改每个固定窗口的计数器。接下来，再根据当前时间戳计算当前窗口的加权值，以及上一个窗口的请求率的加权值，以平滑突发流量。例如，如果当前窗口是25%，那么我们将前一个窗口的计数加权75%。
![限流算法-滑动窗口](http://img.xinzhuxiansheng.com/blogimgs/technicalessential/限流算法-滑动窗口.png)


## 漏桶算法
利用一个缓存区，当有请求进入系统时，无论请求的速率如何，都先在缓存区内保存，然后以固定的流速流出缓存区进行处理，如图3.4所示。漏桶算法的特点是无论外部请求压力如何，漏桶算法总是以固定的流速处理数据。漏桶的容积和流出速率是该算法的两个重要参数

![限流算法-漏桶算法](http://img.xinzhuxiansheng.com/blogimgs/technicalessential/限流算法-漏桶算法.png)


## 令牌桶算法
令牌桶算法是一种反向的漏桶算法。在令牌桶算法中，桶中存放的不再是请求，而是令牌。处理程序只有拿到令牌后，才能对请求进行处理。如果没有令牌，那么处理程序要么丢弃请求，要么等待可用的令牌。为了限制流速，该算法在每个单位时间产生一定量的令牌存入桶中。比如，要限定应用每秒只能处理1个
请求，那么令牌桶就会每秒产生1个令牌。通常，桶的容量是有限的，比如，当令牌没有被消耗掉时，只能累计有限单位时间内的令牌数量

![限流算法-令牌桶算法](http://img.xinzhuxiansheng.com/blogimgs/technicalessential/限流算法-令牌桶算法.png)

## 限流度量及触发条件
**根据上述算法，关键的度量指标就是计数器**
* 漏桶中的请求数是否已经达到阈值。
* 令牌桶中的令牌数是否已经领光。
* 固定窗口或滑动窗口中的计数器是否已经达到阈值。
* 滑动日志中所存储的日志数是否已经达到阈值。
**当然，还可以设置更加细致的匹配和分组条件**
例如：
* API端点信息，如url、responseCode、header、method、param。
* 用户信息，如userId、orgId。
* ip地址信息，如source_address、x-forwarded-for。
**触发条件一般是单位时间内的最大请求数**
例如：
* 单位时间内的请求数（request count per interval）
* 单位时间内的错误码次数（error code count per interval）
* 单位时间内的并发请求数（concurrent request per interval）

# Reference 

[1]《实战Java高并发程序设计》
[2]《架构不再难》
[3] [《Rate Limiting Part 1》](https://hechao.li/2018/06/25/Rate-Limiter-Part1/)



