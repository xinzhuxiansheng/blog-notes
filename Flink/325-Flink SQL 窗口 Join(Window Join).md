## Flink SQL 窗口 Join（Window Join）       

### 引言    
之前介绍过普通 Join 属于无界数据流的 join，时间区间 join 属于有界数据流的 join。这里的窗口 join（Window Join）也属于有界数据流的 join, 

### 介绍
`简单来说窗口 join 就是将两条无界数据流的数据通过窗口划分为有界数据流，然后针对相同窗口的数据进行 join`，这里的时间窗口支持滚动窗口、滑动窗口等。在使用窗口 join 的时候,通常建议和 Windowing TVF 一起使用，因为 Windowing TVF 窗口聚合缓冲区的数据存储在托管内存中，所以不存在内存 GC或者内存移除的风险。 

窗口 join 支持 Inner Join，Left Join, Right Join和 Full Join。针对窗口 join, 我们在使用的时候有两点需要特别注意。   
* 窗口 join 目前不支持使用处理时间，只支持事件时间          
* 窗口 join 目前不支持不同的时间窗口大小，两个数据流的窗口大小需要一致                

### Window Join 与 Interval Join 的对比 
接下来，我们具体对比一下窗口 Join 和时间区间 Join，`它们都可以将无界数据流划分为有界数据流进行 JOIN 关联`，但是他们还是有一些区别的:        

* 针对窗口 Join 来说：当窗口划分的比较小的时候,在窗口边缘关联不上的数据就会比较多，最终导致得到的结果的“数据质量”会比较差。当窗口划分的比较大的时候,窗口内关联上的数据就会比较多，最终得到的结果的数据质量会比较好。但是会导致得到结果的延迟比较大或者说是实效性比较差，所以在使用的时候也需要均衡考虑。    

示例： 以订单数据关联支付数据来说，如果我们指定的时间窗口大小为1分钟, 当订单数据的时间为00:59 ,支付数据的时间为1:01, 这样会导致无法关联，因为这两条数据会被划分到两个时间窗口中, 时间窗口越小，无法关联的数据就越多。 如果我们把时间窗口调大, 假设调整为1小时，那么只有在每个小时边界处的数据才会出现关联不上的情况,这样会好一些，但是数据的延迟就比较大了,所以窗口 Join 适合应用在窗口内数据关联率比较高的场景中, 如果窗口内的数据关联率不高，则不建议使用。基于此，窗口 Join 在实际生产环境中很少使用。       

* 针对时间区间 Join 来说： 在得到的结果的数据质量层面上，时间区间 join要比窗口 join 好，但是时间区间 join 也会出现 join 不到的情况。 时间区间 Join 适合应用在两条数据流之间可以明确评估出相互延迟时间的场景中。 

示例： 左流和右流的时间相差在1分钟之内的数据有90%, 在 1-5分钟之内的数据有9.5%， 可以认为两条数据流中的时间相差在5分钟之内的有99.5%, 这个时候我们可以将上下边界设置为5分钟, 就可以保证99.5%的数据都可以关联上，并且不会导致很大的数据延迟,剩余的0.5% 误差率属于可以接受的合理误差范围, 所以在实际工作中，时间区间 join 还是比较常用的。  

`如果用两句话来总结窗口 join 和时间区间 join 之间的区别 可以这样理解。 窗口 Join 适合双流数据时间同步的情况,时间区间 Join 适合双流数据时间不同步的情况`, 在实际工作中，大概率双流数据的时间是不同步的,所以在实际工作中窗口 Join很少使用，时间区间 Join 比较常见。




