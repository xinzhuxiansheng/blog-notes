## Flink SQL 时间区间 Join(Interval Join)   

### 引言    
在上一篇 Blog 中介绍Flink SQL 的普通 Join，正常的数据流关联使用普通Join 这种类型就可以了，那为什么还需要这个`时间区间 Join`呢？    

主要是因为普通 Join 会产生回撤流，这样会导致数据重复下发的问题,并且有一些存储引擎也不具备处理回撤流的能力。其实最开始 Kafka 也不支持回撤流,后来通过 upsert-kafka connector 组件才对回撤流功能提供了支持。  

回撤流主要出现在普通 Join 中的 Left Join，Right Join和 Full Join中，INNER JOIN 不会产生回撤流，产生回撤流是因为数据没有关联上而提前下发结果导致的。能不能让 Left Join，Right Join 和 Full Join数据也互相等待一段时间，不要一上来就下发结果数据。        

以 Left Join 为例来说,当左表中有新增数据的时候，如果到右表中没有关联到则等待一段时间，如果在这段时间内还没有等到对应的数据则下发结果 +(L,null),确实的数据还是用null 填充,如果在这一段时间内等到了对应的数据，则下发完整结果 +(L,R)。按照这种思路就不会产生回撤流了,针对没有关联上的数据就算后期缺失的数据过来了也不会去关联了,这个思路其实就是时间区间 Join 的实现思路, 所以时间区间 Join 不会产生回撤流。其实有一种应用场景非常适合使用时间区间 Join，在外卖平台中，外卖订单下单之后，一般会要求15分钟内支付，否则就会取消订单,下单数据和支付数据对应的是两个实时数据流,针对这个场景，如果我们希望在流计算中将订单数据和支付数据进行实时关联，其实就可以使用区间 Join 了。 我们可以设置一个时间范围，可以比15分钟稍微大一些,这样正常支付的订单就可以获取到支付数据进行关联了。针对超时未支付的订单,我们也会将缺失的字段置为null下发数据，这样既不会产生回撤流也不会导致无限制的等待。          

### 定义    
时间区间Join：  
* 其实是用一个流的数据与关联另一个流中一段时间区间的数据            
若关联到就下发关联到的数据，关联不到且在时间区间超时后,就下发没有关联到的数据。注意： 如果是 INNER JOIN 
在没有关联到且超时后是不会下发数据的，因为 INNER JOIN 下发的结果必须是完整的。 Outer JOIN（Left Join，Right Join 和 Full Join）则会下发没有关联到的数据。           

* 支持 Inner Join，Left Join，Right Join，Full Join         

* 在使用时间区间 Join 时,需要定义好时间属性字段。              
时间区间 JOIN目前只支持查询带有时间属性的 Append-only 类型的表，时间属性字段支持处理时间 ProcessingTime以及事件时间 EventTime，

### JOIN 过程   
针对时间区间 JOIN 中数据的关联思路可以看一下下面这个图，加深理解。 图中表示两个流表 A 和 B 进行时间区间 JOIN。        

表 A 和表 B 在 Join的时候，在表 B上指定了一个时间区间,这样他们在关联的时候，表 A 只会和表 B中指定时间区间的数据进行关联。 同时在表 A上也指定了一个时间区间, 表 B 只会和 表 A 中指定时间区间内的数据进行关联。   

#### 示例   
表 A 中有一条数据0,此时表 B 中对应的时间区间内有 A 和 B 这两条数据,所以表 A中的0只会和表 B中的A和B这两条数据进行关联。表B 中有一条数据A，此时表 A中的时间区间内有0和1这两条数据，所以表 B中的A 这条数据只会和表 A 中的0和1这两条数据进行关联。 后面的以此类推, 接下来 我们结合一个时间区间 Join的案例具体分析一下,   
```sql
SELECT
 uo.order_id,
 uo.d_timestamp,
 pf.pay_money
FROM user_order AS uo
INNER/LEFT/RIGHT/FULL JOIN payment_flow AS pf ON uo.order_id = pf.order_id
-- 指定取值的时间区间
AND uo.d_timestamp 
 BETWEEN pf.d_timestamp - INTERVAL '10' MINUTE -- 左边界
 AND pf.d_timestamp + INTERVAL '10' MINUTE -- 右边界
```
关键配置参数是在于 JOIN ON 后面关于时间区间的指定, 针对这个时间区间的限定，简单理解就是数据流在关联数据的时候会和另一边数据流中前后十分钟内的数据进行关联,前后十分钟对应的是一个20分钟的时间区间, 那针对这个案例，底层在实现数据关联的时候时间区间是这样划分的。 如下图所示：       


